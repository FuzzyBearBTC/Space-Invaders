function Drawable(e,t,n,r,i,s){this.x=e;this.y=t;this.width=n;this.height=r;this.column=i;this.row=s}function intersects(e,t,n,r,i,s,o,u){o+=i;n+=e;if(i>n||e>o)return false;u+=s;r+=t;if(s>r||t>u)return false;return true}function Movable(e,t,n,r,i,s){Drawable.call(this,e,t,n,r,i,s);Movable.prototype.shoot=function(){soundManager.missileSound();if(this.column!=null)return new Missile(this.x+10,this.y+15,this.column);else return new Missile(this.x+10,this.y+5,this.column)};Movable.prototype.collidesWithEdge=function(){if(this.x>514||this.x<0)return true;return false}}function Animation(e,t,n,r,i,s){this.image=e;this.frame_width=r;this.frame_height=i;this.current_x=t;this.current_y=n;this.change=true;this.frameAddition=s}function InvaderManager(){function o(t,n){l(t,n);if(m()){if(s)u(-1-r,25);else u(1+r,25);s=!s}if(spritemanager.changeSprite(e)){if(s)u(r,0);else u(-r,0)}}function u(t,n){$.each(e,function(e,r){for(var i=0;i<r.length;++i){r[i].move(t,n)}})}function a(t){for(var n=0;n<e.length;++n){for(var r=0;r<e[n].length;++r){e[n][r].draw(t)}}}function f(t,n){for(var r=0;r<e.length;++r){for(var i=0;i<e[r].length;++i){var s=e[r][i];if(!s.hasCollided()&&s.doesCollide(t)){n.raiseScore(s.getRow());s.explode();c(r,i);return true}}}return false}function l(t,n){for(var r=0;r<e.length;++r){for(var i=0;i<e[r].length;++i){var s=e[r][i];if(!s.hasCollided()&&t.doesCollide(s,n)){s.explode();c(r,i)}}}}function c(e,n){setTimeout(function(){y();g(e,n);--t},100)}function h(){for(var t=0;t<e.length;++t){if(!invaderColumnShot[t]){if(p(e[t]))invaderColumnShot[t]=true}}return n}function p(e){if(e.length>0){if(Math.random()<i){n.push(e[e.length-1].shoot());return true}}return false}function d(){return t}function v(){return e}function m(){for(var t=0;t<e.length;++t){for(var n=0;n<e[t].length;++n){if(e[t][n].collidesWithEdge())return true}}return false}function g(t,n){e[t].splice(n,1)}function y(){r+=.06;spritemanager.decreaseFrametime()}function b(e){r=e}function w(e){i=e}var e=[];var t=55;var n=[];var r=3;var i=.005;var s=true;$.each(invaderData,function(t,n){var r=new Invader(n[0],n[1],n[2],n[3]);var i=t%11;if(!e[i])e[i]=[];var s=spritemanager.getSprite(n[2]);r.createAnimation(s);e[i].push(r)});return{draw:a,doesCollide:f,getNumOfInvaders:d,shootLogic:h,update:o,getInvaders:v,setSpeed:b,setChance:w}}function Invader(e,t,n,r){Drawable.call(this,e,t,25,20,r,n);this.sprite=[];this.collision=false;this.animation={};Invader.prototype.draw=function(e){this.animation.draw(e,this.x,this.y,this.width,this.height)};Invader.prototype.createAnimation=function(e){this.sprite=e;this.animation=new Animation($("#invaders")[0],this.sprite[0],this.sprite[1],this.sprite[2],this.sprite[3],32)};Invader.prototype.animate=function(){this.animation.next()};Invader.prototype.hasCollided=function(){return this.collision};Invader.prototype.explode=function(){soundManager.eightBitExplosionSound();this.animation=new Animation($("#kaboom")[0],0,0,34,23,0);this.collision=true}}function BonusInvader(){Drawable.call(this,10,80,30,20);this.img=new Image;this.img.src="img/bonus.png";this.directionRight=true;BonusInvader.prototype.draw=function(e){soundManager.flightSound();e.drawImage(this.img,0,0,52,27,this.x,this.y,this.width,this.height)}}function WallManager(){function r(t){for(var n=0;n<e.length;++n){e[n].draw(t)}}function i(t,n){for(var r=0;r<e.length;++r){if(e[r].doesCollide(t,n))return true}return false}var e=[];for(var t=0;t<4;++t){var n=new Wall(wallData[t],roundedTilesData[t]);e.push(n)}return{draw:r,doesCollide:i}}function Wall(e,t){function s(e){for(var t=0;t<i.length;++t){i[t].draw(e)}}function o(e,t){for(var n=0;n<i.length;++n){if(i[n].doesCollide(e)){t.newExplosion(i[n].getX(),i[n].getY());u(n);return true}}return false}function u(e){i.splice(e,1)}var n=new Array;var r=new Array;var i=new Array;$.each(t,function(e,t){var n=new RoundedTile(t[0],t[1],t[2]);r.push(n);i.push(n)});$.each(e,function(e,t){var r=new Tile(t[0],t[1]);n.push(r);i.push(r)});return{draw:s,doesCollide:o}}function Tile(e,t){Drawable.call(this,e,t,14,20);Tile.prototype.draw=function(e){e.fillStyle="rgb(0,255,0)";e.fillRect(this.x,this.y,this.width,this.height)}}function RoundedTile(e,t,n){this.clockwise=n;Drawable.call(this,e,t,14,20);RoundedTile.prototype.draw=function(e){e.fillStyle="rgb(0,255,0)";e.strokeStyle="rgb(0,255,0)";e.lineWidth=1;e.beginPath();if(!this.clockwise)this.drawCounterClockWise(e);else this.drawClockWise(e);e.stroke();e.fill()};RoundedTile.prototype.drawClockWise=function(e){e.moveTo(this.x+.5,this.y);e.lineTo(this.x+.5,this.y+this.height-.5);e.lineTo(this.x+this.width-.5,this.y+this.height-.5);e.quadraticCurveTo(this.x+this.width,this.y+.5,this.x,this.y+.5)};RoundedTile.prototype.drawCounterClockWise=function(e){var t=this.x+this.width;e.moveTo(t-.5,this.y);e.lineTo(t-.5,this.y+this.height-.5);e.lineTo(t-this.width+.5,this.y+this.height-.5);e.quadraticCurveTo(t-this.width,this.y+.5,t,this.y+.5)}}function Player(){Movable.call(this,260,500,25,25);this.lives=3;this.img=new Image;this.img.src="img/ships2.png";Player.prototype.draw=function(e,t){e.drawImage(this.img,t,12,80,72,this.x,this.y,this.width,this.height)}}function Missile(e,t,n){Drawable.call(this,e,t,3,5,n);Missile.prototype.draw=function(e){e.fillStyle="rgb(255,255,255)";e.fillRect(this.x,this.y,this.width,this.height)}}function ScoreManager(){function i(n){if(n<1)e+=30;else if(n<3)e+=20;else if(n==5)e+=100;else e+=10;if(e>t)t=e}function s(){return t}function o(){return e}function u(){n.save({userID:$.cookie("userId"),score:e})}function a(e){r.equalTo("userID",$.cookie("userId"));r.exists("score");r.descending("score");r.limit(5);r.find({success:function(t){e.font="20px Courier New";if(t.length<1){e.fillText("No scores yet! Go and play!",115,305);return}var n=305;for(var r=0;r<t.length;++r){e.fillText(r+1+": "+t[r].attributes.score,230,n);n+=30}}})}Parse.initialize("xR4SolA0VPCzrf7Pp9zuBDVOM6EB6KodPAnWbgso","JoAmAsdAt3lHQCkqAIVPVDDyYMVCRIo9PZrrQfMM");var e=0;var t=0;var n=new GameScore;var r=new Parse.Query(GameScore);r.equalTo("userID",$.cookie("userId"));r.descending("score");r.limit(1);r.find({success:function(e){if(e.length==0)t=0;else t=e[0].attributes.score}});return{raiseScore:i,getScore:o,getHighScore:s,showScores:a,postScore:u}}function ExplosionManager(){function t(t,n){e.push(new Explosion(t,n));soundManager.explosionSound()}function n(t){for(var n=0;n<e.length;++n){var i=e[n];if(i.empty()){e.splice(n,1);--n}}if(e.length>0)r(t)}function r(t){for(var n=0;n<e.length;++n){e[n].draw(t)}}var e=[];return{update:n,newExplosion:t}}function Explosion(e,t){this.particles=[];for(var n=0;n<30;++n){this.particles.push(new Particle(e,t))}Explosion.prototype.empty=function(){for(var e=0;e<this.particles.length;++e){if(this.particles[e].radius<=0){this.particles.splice(e,1);--e}}if(this.particles.length==0)return true;else return false};Explosion.prototype.draw=function(e){for(var t=0;t<this.particles.length;t++){var n=this.particles[t];e.beginPath();e.globalCompositeOperation="lighter";e.arc(n.x,n.y,n.radius,0,Math.PI*2,false);e.fillStyle="rgba("+n.r+", "+n.g+", "+n.b+", 0.5)";e.fill();n.x+=n.vx;n.y+=n.vy;n.radius-=.2}}}function Particle(e,t){this.x=e;this.y=t;this.radius=3+Math.random()*4;this.r=Math.round(Math.random())*255;this.g=Math.round(Math.random())*255;this.b=Math.round(Math.random())*255;this.vx=-10+Math.random()*20;this.vy=-10+Math.random()*20}var spritemanager={};spritemanager=function(){function n(n){var r=(new Date).getTime()/1e3;if(r-t>e){for(var i=0;i<n.length;++i){for(var s=0;s<n[i].length;++s){n[i][s].animate();t=r}}return true}return false}function r(e){if(e==0)return sprite=[0,4,30,25];else if(e==1||e==2)return sprite=[69,4,30,25];else return sprite=[143,4,30,25]}function i(){e-=.009}function s(){e=.5}var e=.5;var t=0;return{changeSprite:n,getSprite:r,decreaseFrametime:i,resetFrametime:s}}();var configuration=function(){function e(){if(jQuery.browser.mobile==true){t();n();s()}else{r()}i();o()}function t(){soundManager.disableSounds()}function n(){$("<div/>").attr("id","left").text("Left").appendTo(".buttons");$("<div/>").attr("id","shoot").text("Shoot").appendTo(".buttons");$("<div/>").attr("id","right").text("Right").appendTo(".buttons")}function r(){$("#spaceinvaders").click(function(e){var t=Math.floor(e.pageX-$(this).offset().left);var n=Math.floor(e.pageY-$(this).offset().top);if(t>=502&&t<=535&&n>=545&&n<=580){if(soundManager.areSoundsOn()){soundManager.disableSounds()}else{soundManager.enableSounds()}}})}function i(){$(document).keydown(function(e){keyhandler.keydown(e.which);if(keyhandler.isValidKey(e.which))e.preventDefault()});$(document).keyup(function(e){keyhandler.keyup(e.which);if(keyhandler.isValidKey(e.which))e.preventDefault()})}function s(){$("#right").swipe({swipeStatus:function(e,t,n,r,i,s){if(t=="start"||t=="move")keyhandler.pressRight();if(t=="end"||t=="cancel")keyhandler.clear()}});$("#left").swipe({swipeStatus:function(e,t,n,r,i,s){if(t=="start"||t=="move")keyhandler.pressLeft();if(t=="end"||t=="cancel")keyhandler.clear()}});$("#shoot").swipe({swipeStatus:function(e,t,n,r,i,s){if(t=="start"||t=="move")keyhandler.pressUp();if(t=="end"||t=="cancel")keyhandler.clear()}})}function o(){u()}function u(){var e=localStorage.getItem("userId");if(e!=null)$.cookie("userId",e);if($.cookie("userId")!=null)return;var t=a();localStorage.setItem("userId",t);$.cookie("userId",t,{expires:30})}function a(){var e="";var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var n=0;n<5;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}return{init:e}}();var soundManager=function(){function s(){e=true}function o(){e=false}function u(){if(e){var t=n;t.volume=.6;t.load();t.play()}}function a(){if(e){var n=t;n.volume=.4;n.load();n.play()}}function f(){if(e){var t=r;t.volume=.3;t.load();t.play()}}function l(){if(e){var t=i;t.volume=.1;t.play()}}function c(){return e}var e=true;var t=$("#8bit-explosion")[0];var n=$("#explosion")[0];var r=$("#missile")[0];var i=$("#flight")[0];return{areSoundsOn:c,enableSounds:s,disableSounds:o,explosionSound:u,eightBitExplosionSound:a,missileSound:f,flightSound:l}}();Drawable.prototype.move=function(e,t){this.x+=e;this.y+=t};Drawable.prototype.getX=function(){return this.x};Drawable.prototype.getY=function(){return this.y};Drawable.prototype.getWidth=function(){return this.width};Drawable.prototype.getHeight=function(){return this.height};Drawable.prototype.getColumn=function(){return this.column};Drawable.prototype.getRow=function(){return this.row};Drawable.prototype.doesCollide=function(e){if(intersects(this.x,this.y,this.width,this.height,e.getX(),e.getY(),e.getWidth(),e.getHeight()))return true;else return false};Movable.prototype=new Drawable;Movable.prototype.constructor=Movable;Animation.prototype.next=function(){if(this.change)this.current_x+=this.frameAddition;else this.current_x-=this.frameAddition;this.change=!this.change};Animation.prototype.draw=function(e,t,n,r,i){e.drawImage(this.image,this.current_x,this.current_y,this.frame_width,this.frame_height,t,n,r,i)};var invaderData=[[60,135,0,0],[100,135,0,1],[140,135,0,2],[180,135,0,3],[220,135,0,4],[260,135,0,5],[300,135,0,6],[340,135,0,7],[380,135,0,8],[420,135,0,9],[460,135,0,10],[60,160,1,0],[100,160,1,1],[140,160,1,2],[180,160,1,3],[220,160,1,4],[260,160,1,5],[300,160,1,6],[340,160,1,7],[380,160,1,8],[420,160,1,9],[460,160,1,10],[60,185,2,0],[100,185,2,1],[140,185,2,2],[180,185,2,3],[220,185,2,4],[260,185,2,5],[300,185,2,6],[340,185,2,7],[380,185,2,8],[420,185,2,9],[460,185,2,10],[60,210,3,0],[100,210,3,1],[140,210,3,2],[180,210,3,3],[220,210,3,4],[260,210,3,5],[300,210,3,6],[340,210,3,7],[380,210,3,8],[420,210,3,9],[460,210,3,10],[60,235,4,0],[100,235,4,1],[140,235,4,2],[180,235,4,3],[220,235,4,4],[260,235,4,5],[300,235,4,6],[340,235,4,7],[380,235,4,8],[420,235,4,9],[460,235,4,10]];var invaderColumnShot=[false,false,false,false,false,false,false,false,false,false,false];Invader.prototype=new Movable;Invader.prototype.constructor=Invader;BonusInvader.prototype=new Movable;BonusInvader.prototype.constructor=BonusInvader;var keyhandler=function(){function n(){return e[38]||e[175]||e[87]}function r(){return e[40]||e[176]||e[83]}function i(){return e[37]||e[178]||e[65]}function s(){return e[39]||e[177]||e[68]}function o(t){e[t]=true}function u(t){e[t]=false}function a(){e[38]=true;e[175]=true;e[87]=true;e[32]=true}function f(){e[37]=true;e[178]=true;e[65]=true}function l(){e[39]=true;e[177]=true;e[68]=true}function c(){if(n()||e[32])return true;return false}function h(){var e=0;if(i()){e=-2}if(s()){e=2}return e}function p(e){return e==38||e==175||e==87||e==32||e==37||e==178||e==65||e==39||e==177||e==68||e==40}function d(){var t=0;while(t<256){e[t]=false;t=t+1}}var e=new Array;var t=0;while(t<256){e[t]=false;t=t+1}return{isValidKey:p,keydown:o,keyup:u,getMovement:h,getAction:c,clear:d,pressLeft:f,pressRight:l,pressUp:a}}();"use strict";var wallData=[[[77,455],[119,455],[91,435],[105,435]],[[187,455],[229,455],[201,435],[215,435]],[[297,455],[339,455],[311,435],[325,435]],[[407,455],[449,455],[421,435],[435,435]]];var roundedTilesData=[[[77,435,false],[119,435,true]],[[187,435,false],[229,435,true]],[[297,435,false],[339,435,true]],[[407,435,false],[449,435,true]]];Tile.prototype=new Drawable;Tile.prototype.constructor=Tile;RoundedTile.prototype=new Drawable;RoundedTile.prototype.constructor=RoundedTile;Player.prototype=new Movable;Player.prototype.constructor=Player;Missile.prototype=new Drawable;Missile.prototype.constructor=Missile;var GameScore=Parse.Object.extend("GameScore");"use strict";window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}();var engine=function(){function d(){c=keyhandler.getMovement();h=keyhandler.getAction()}function v(){if(e.lives<1||r.getNumOfInvaders()<1)p=true;$.each(r.getInvaders(),function(t,n){for(var r=0;r<n.length;++r){if(n[r].getY()>460){e.lives=0;p=true;return}}});if(p)return;y();b();w();E();S();x()}function m(e){e.fillStyle="rgb(0,0,0)";e.fillRect(180,265,180,33);e.font="bold 30px Courier New";e.fillStyle="rgb(255,255,255)";e.fillText("GAME OVER",190,280);g(e);$("#spaceinvaders").on("click.endGame",function(e){$("#spaceinvaders").off("click.endGame");C();P()})}function g(e){if(p)t.postScore();t.showScores(e)}function y(){if(e.collidesWithEdge()){if(e.getX()>514&&c<0)e.move(c,0);else if(e.getX()<0&&c>0)e.move(c,0)}else if(!e.collidesWithEdge())e.move(c,0)}function b(){if(h&&a==null)a=e.shoot();if(a!=null){if(n.doesCollide(a,i)||r.doesCollide(a,t))a=null;else if(s!=null&&s.doesCollide(a)){a=null;i.newExplosion(s.getX(),s.getY());s=null;t.raiseScore(5)}else if(a.getY()<70)a=null;else a.move(0,-10)}}function w(){if(s==null&&u>0){if(r.getNumOfInvaders()<35){if(Math.floor(Math.random()*1e3+1)<3){s=new BonusInvader;u=0}}}if(s!=null){if(s.collidesWithEdge())s.directionRight=!s.directionRight;if(s.directionRight)s.move(3,0);else s.move(-3,0);if(f==null){if(Math.random()<.015)f=s.shoot()}}}function E(){if(f!=null){if(e.doesCollide(f)){e.lives-=1;i.newExplosion(e.getX(),e.getY());f=null}else if(n.doesCollide(f,i)||f.getY()>533){f=null}else f.move(0,3)}}function S(){r.update(n,i)}function x(){l=r.shootLogic();if(l.length>0){for(var t=0;t<l.length;++t){var s=l[t];if(e.doesCollide(s)){e.lives-=1;i.newExplosion(e.getX(),e.getY());invaderColumnShot[s.getColumn()]=false;l.splice(t,1);--t}else if(n.doesCollide(s,i)||s.getY()>533){invaderColumnShot[s.getColumn()]=false;l.splice(t,1);--t}else s.move(0,1)}}}function T(){var t=$("#spaceinvaders")[0].getContext("2d");t.clearRect(0,0,540,580);t.fillStyle="rgb(0,0,0)";t.fillRect(0,0,540,580);_(t);M(t);n.draw(t);O(t);k(t);A(t);L(t);i.update(t);if(p){if(e.lives>0)N(t);else m(t)}t=null}function N(e){e.fillStyle="rgb(0,0,0)";e.fillRect(180,265,180,33);e.font="20px Courier New";e.fillStyle="rgb(255,255,255)";e.fillText("CONGRATULATIONS!",178,250);e.fillText("Next level is about to start...",85,280);setTimeout(function(){C();++o;r.setSpeed(3+o/10);r.setChance(.005+o/250);D()},3e3)}function C(){if(e.lives<1)e=new Player;r=new InvaderManager;n=new WallManager;i=new ExplosionManager;a=null;f=null;s=null;u=1;l=null;spritemanager.resetFrametime();h=false;p=false;for(var t=0;t<invaderColumnShot.length;++t){invaderColumnShot[t]=false}}function k(t){t.lineWidth=2;t.strokeStyle="rgb(0,255,0)";t.beginPath();t.moveTo(0,540);t.lineTo(540,540);t.stroke();var n=e.img;var r=50;for(var i=0;i<e.lives;++i){t.drawImage(n,0,12,80,72,r,550,25,25);r+=30}t.font="20px Courier New";t.fillStyle="rgb(255, 255, 255)";t.fillText(e.lives+"x",20,570);t.fillText("LEVEL",340,30);t.fillText(o,340,50)}function L(e){var t=$("#sound-icon")[0];e.drawImage(t,500,543,35,35);if(!soundManager.areSoundsOn()){e.strokeStyle="rgb(255,255,255)";e.lineWidth=2;e.beginPath();e.moveTo(507,571);e.lineTo(529,550);e.stroke()}}function A(e){e.fillText("SCORE",20,30);e.fillText(t.getScore(),20,50);e.fillText("HIGH SCORE",140,30);e.fillText(t.getHighScore(),140,50)}function O(e){if(s!=null)s.draw(e);r.draw(e)}function M(t){if(c==-2)var n=147;else if(c==2)n=78;else n=0;e.draw(t,n)}function _(e){if(a!=null)a.draw(e);if(f!=null)f.draw(e);if(l.length>0){$.each(l,function(t,n){n.draw(e)})}}function D(){engine.input();engine.logic();engine.render();if(!p)requestAnimFrame(engine.tick)}function P(){var e=$("#spaceinvaders")[0].getContext("2d");e.clearRect(0,0,540,580);e.fillStyle="rgb(0,0,0)";e.fillRect(0,0,540,580);e.fillStyle="rgb(255,255,255)";e.font="bold 30px Courier New";e.fillText("START GAME",175,270);e.fillText("HIGH SCORES",175,320);var n=new Image;n.src="img/logo2.png";n.onload=function(){e.drawImage(n,44,20,450,200);e=null};$("#spaceinvaders").on("click.menu",function(e){var n=Math.floor(e.pageX-$(this).offset().left);var r=Math.floor(e.pageY-$(this).offset().top);if(n>=176&&n<=361&&r>=251&&r<=273){$("#spaceinvaders").off("click.menu");t=new ScoreManager;engine.tick()}else if(n>=176&&n<=379&&r>=299&&r<=322){$("#spaceinvaders").off("click.menu");engine.highscore()}})}function H(){var e=$("#spaceinvaders")[0].getContext("2d");e.fillStyle="rgb(0,0,0)";e.clearRect(0,250,540,580);e.fillRect(0,250,540,580);e.fillStyle="rgb(255,255,255)";t.showScores(e);$("#spaceinvaders").on("click.highscore",function(e){$("#spaceinvaders").off("click.highscore");P()})}var e=new Player;var t=new ScoreManager;var n=new WallManager;var r=new InvaderManager;var i=new ExplosionManager;var s;var o=1;var u=1;var a;var f;var l=[];var c;var h=false;var p=false;return{input:d,logic:v,render:T,tick:D,menu:P,highscore:H}}();$(document).ready(function(){configuration.init();engine.menu()});